%%recovers a crashed editor session using journal files.
%% 
%%History.

%%
%%    Copyright (C) 2013-2018 Jon. Easterbrook
%%
%%    This file is part of jot (Joy Of Text - a text editor).
%%
%%    jot is free software: you can redistribute it and/or modify
%%    it under the terms of the GNU General Public License as published by
%%    the Free Software Foundation, either version 3 of the License, or
%%    (at your option) any later version.
%%
%%    jot is distributed in the hope that it will be useful,
%%    but WITHOUT ANY WARRANTY; without even the implied warranty of
%%    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%%    GNU General Public License for more details.
%%
%%    You should have received a copy of the GNU General Public License
%%    along with jot.  If not, see <https://www.gnu.org/licenses/>.
%%
%%

%g? 
  Usage:
    Restart the editor with -init=%r=journal_recover
    It picks up the journal file using the pathname of the primary file - <primaryPathName>.jnl/history.txt
    A copy of the primary file and any modified secondaries is in the same directory.
    
  For simple cases the following procedure should be sufficient:
    jot <originalPrimaryFile> -init="%r=journal_recover"
  then
    jot <originalPrimaryFile> -init="%r=./recover_now.jot -asConsole"
  It may be necessary to edit the ./recover_now.jot script - especially if the original failure was due 
  to operator error, then you will need to remove the faulty commands from the script before running it. 
    
  Buffers, original contents of these are held in the ^ buffer while this script extracts the next command.:
    j - The history.txt file
    c - the current key code or escape sequence from history
    t - the hotkey/escape sequence translation from the ^ buffer.
    o - the recovery script.
    p - the journal-directory path.
    n - the Ctrl+C command count.
:

%g#
%%Main recovery macro.
%%
%%Check for readonly buffers etc - remove all locks.
ob %q~=system; f/Buffers:/m 
%%Buffer loop - reset write lock etc on all buffers.
( f1/ Buffer /- q/a-z/m, oicoz %b=unrestricted; z~m)0 osozok
 
%%Pick up pathName for primary.
%q~=buffer; f/pathName = /-n.r0ap&zpr0i".jnl/"
%%Read the history file.
z. (%ij='p/history.txt;, %x=Cannot open history file 'p/history.txt - giving up now; )
%%Add a dummy keycode for simple typed-in commands.
z^m0r0b-i/        /
%%Clear out the output buffer.
%qo=date
ki/%%Recovery file generated by journal_recover.jot, run date /r0b
zj %q~=buffer; f/pathname = /-e-0i/%%Using history file /m-k-0 f/currentDatestamp = /-e-0j-i/ dated / zoi'~ okb
i/ob/b zjm-0

%%Read the copy of the original primary file from the journal area.
zjm-0f/<<Primary file /-n.f1/>>/a$&mf2/<<ReadFile /-
(n.f1/)  to buffer ./
  %%Read the backup copy of the primary file.
  ac&zcr0(f-1/ (/s/_/, i/_/)(f-1/ /i/\/)0 (f-1"/"-e-0, ) r-0i/%i.=/hpr0 i/; %b=pathname /h$,
  %%The primary file was readonly - re-read the original version.
  n.f1/ to buffer ./ac&zcr-0i/%i.=/) zohcb

%%Disable I/O.
i"%s=recoverymode 1"b
 
%%Check that the xterm height is the same - *very* important if there are any PageUp or PageDown operations in the session.
ob (zjm-0f/<<Screen height /-oid f1/Guard band size /-oid, %X=Error in Screen-height entry in history file.; ) m
oso# %q~=window; f/ screenHeight = /-oidzjosok (o=, %X=Original screen height was '~ - you must adjust your xterm to match, then try again.;, ) okok osoz
%%Add instruction to set the guardband.
zoi/%s=guardband /i'~ b

%%Re-run the startup script with recoverymode set - to pick up files from journal area.
zjf/<<Startup script>>/n.mf1/<<Running script /r0ac&m zohcf-1//-n.f1/>>/ac& 
%%Construct the correct path for the startup script.
r0bi/%%Re-run the startup script with recoverymode turned on./b-m-2i/%%/mi//m2 i/%r=/hc-(v"/", i"./")r0b

( %%Main loop - translate history into a recovery script. 
  %%Pick up the keycode and the string argument.
  zj n.r0ac&m
  ( %%Is this a readFile operation, a keycode or some text?
    %%Comment out failed reads.
    zcv/<<Read file failed>>/ i.//.zom-r-0i.//.m, 
    %%Comment out invalid commands.
    zcv/<InvalidCommand>/ i/%%/zom-k,
    %%Pass original %i and %e commands, also pass the primary file, actual pathnames will be modified with %s=recoverymode 1 set.
    zcr-0f1/<<ReadFile / (f/)  to buffer /e0 f-1/ (/s/_/ ((f-1/[/, f-1./.-, f-1/ /-)e-0, ) r-0hp, f1/ to buffer/e0f-1/ /-e-0) zohc b,
    %%Remove the startup-end mark and add commands to insert escape sequence for emulation of Backspace and Enter keys. 
    zcv/<<Startup Sequence ends,/
      zoi"obz^m-0i/<<DEL>> i`## `e-(e-, j-)/b"b  i"i/<<INS>> i`## `e-/b"b  i"i/<<BRK>> i`## `e-b/b oz"b
      %%The -init commands can go in now.
      zjm-0(f/<<Init commands follow>>/mn.r0ac& zoi/%%These are the -init commands./b hcb, ) zjm-0f/<<Startup Sequence ends/m,
    %%Remove command-file calls.
    f1/<<Running script /,
    %%Suppress <Esc I> - we don't need screen-enter mode and it just make life too confusing.
    zc(v/I       /\v/i       /\)\ zoi/%%<<InsertMode>> suppressed/b, 
    %% <<INT>> often used to exit G command and also to exit trace mode - check the next line.
%%    zcv/<<INT>>/ zj(v/<<G-command terminated>>/mzci/:/bi/m-/bei/%%/r0b, ei/%x=/r0b)zohc,
    zcv/<<INT /t zj(v/<<G-command terminated>>/mzci/:/bi/m-/bei/%%/r0b, zcr7n.f1/>>/an&zom-b-i/%s=commandcounter /hni/;/m2n.ac)zohc,
    %%Anything else passes straight through.
    zohcb )
  )0
  
:
'#
 
zo 
i/%%Re-enable file writing./b
i/%s=recoverymode 0/b
%b=pathname ./recover_now.jot
%o
  
%%Final tidy up before recovery.
%q~=system; f/Buffers:/ (z~mf1/  buffer /- (v/$/, oic n.a$z$oo/n.a%c/ '$))0
z.n.a$
o@
%%Clear out all buffers before restarting.
%r=freeall

%%Do it.
%r=./recover_now.jot -asConsole;

